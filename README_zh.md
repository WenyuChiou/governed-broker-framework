# Governed Broker Framework

**ğŸŒ Language / èªè¨€: [English](README.md) | [ä¸­æ–‡](README_zh.md)**

<div align="center">

**LLM é©…å‹•çš„ Agent-Based Model æ²»ç†ä¸­é–“ä»¶**

[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

</div>

---

## æ¦‚è¿°

Governed Broker Framework ç‚ºå»ºæ§‹å¯é çš„ LLM åŸºç¤ Agent-Based Models (ABMs) æä¾›**æŠ€èƒ½æ²»ç†æ¶æ§‹**ã€‚å®ƒç¢ºä¿ LLM çš„æ±ºç­–åœ¨å½±éŸ¿æ¨¡æ“¬ç‹€æ…‹ä¹‹å‰ï¼Œç¶“éå¤šéšæ®µç®¡ç·šçš„é©—è­‰ã€‚

### æ ¸å¿ƒç‰¹è‰²

- **å¤šéšæ®µé©—è­‰**: å¯é…ç½®çš„é©—è­‰å™¨ç¢ºä¿å¯æ¥å—æ€§ã€å¯è¡Œæ€§ã€ç´„æŸã€å®‰å…¨æ€§å’Œä¸€è‡´æ€§
- **å¤šä»£ç†äººæ”¯æ´**: æ”¯æ´å…·æœ‰ä¸åŒæŠ€èƒ½å’Œè³‡æ ¼è¦å‰‡çš„ç•°è³ªä»£ç†äººé¡å‹
- **å¤šå±¤ç‹€æ…‹**: Individualã€Socialã€Shared å’Œ Institutional ç‹€æ…‹å±¤ï¼Œå…·æœ‰å­˜å–æ§åˆ¶
- **å¯æ“´å±• LLM æä¾›è€…**: é è¨­ Ollamaï¼Œå¯æ“´å±•è‡³ OpenAIã€Anthropic ç­‰
- **å®Œæ•´å¯è¿½æº¯æ€§**: å®Œæ•´çš„å¯©è¨ˆè»Œè·¡ä»¥ç¢ºä¿å¯é‡ç¾æ€§

---

## æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ

![æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ](docs/challenges_solutions.png)

| æŒ‘æˆ° | å•é¡Œ | è§£æ±ºæ–¹æ¡ˆ | å…ƒä»¶ |
|------|------|----------|------|
| **å¹»è¦º (Hallucination)** | LLM ç”¢ç”Ÿç„¡æ•ˆ/ä¸å­˜åœ¨çš„å‹•ä½œ | Skill Registry é™åˆ¶åªèƒ½ä½¿ç”¨å·²è¨»å†ŠæŠ€èƒ½ | `SkillRegistry` |
| **è³‡è¨Šä¸å°ç¨±** | LLM ç¼ºä¹ç‹€æ…‹æ„ŸçŸ¥ï¼Œåšå‡ºä¸å¯è¡Œçš„æ±ºç­– | Context Builder æä¾›æœ‰ç•Œå¯è§€å¯Ÿç‹€æ…‹ | `ContextBuilder` |
| **æ±ºç­–ä¸ä¸€è‡´** | çŸ›ç›¾æˆ–ä¸åˆé‚è¼¯çš„é¸æ“‡ | å¤šéšæ®µé©—è­‰å™¨æª¢æŸ¥ PMT ä¸€è‡´æ€§ | `Validators` |
| **ç„¡å¯è¿½æº¯æ€§** | ç„¡æ³•é‡ç¾æˆ–ç¨½æ ¸æ±ºç­– | å®Œæ•´çš„æ™‚é–“æˆ³è¨˜å¯©è¨ˆè»Œè·¡ | `AuditWriter` |
| **éæ§åˆ¶ç‹€æ…‹è®Šæ›´** | ç›´æ¥ã€æœªé©—è­‰çš„ç‹€æ…‹æ›´æ”¹ | State Manager æ§åˆ¶æ‰€æœ‰ç‹€æ…‹æ›´æ–° | `StateManager` |

---

## Skill Proposal æ ¼å¼

æ¡†æ¶è¦æ±‚ LLM ä»¥**çµæ§‹åŒ–çš„ Skill Proposal æ ¼å¼**è¼¸å‡ºæ±ºç­–ï¼š

```json
{
  "skill": "buy_insurance",
  "parameters": {"duration": 1},
  "reasoning": "ä»Šå¹´æ´ªæ°´é¢¨éšªé«˜..."
}
```

### ç‚ºä½•ä½¿ç”¨ Skill Proposalï¼Ÿ

| é¢å‘ | è‡ªç”±æ ¼å¼ LLM è¼¸å‡º | Skill Proposal |
|------|-------------------|----------------|
| **å¯è§£ææ€§** | éœ€è¦è¤‡é›œçš„ NLP | çµæ§‹åŒ– JSONï¼Œæ˜“æ–¼è§£æ |
| **å¯é©—è­‰æ€§** | ç„¡æ³•é©—è­‰ | Skill Registry æª¢æŸ¥è³‡æ ¼ |
| **å¯è¿½æº¯æ€§** | é›£ä»¥è¨˜éŒ„ | å®Œæ•´å¯©è¨ˆè»Œè·¡ |
| **ç‹€æ…‹å®‰å…¨** | ç›´æ¥è®Šæ›´ | åŸ·è¡Œå‰å·²é©—è­‰ |
| **å¯é‡ç¾æ€§** | éç¢ºå®šæ€§ | ç¢ºå®šæ€§æŠ€èƒ½åŸ·è¡Œ |

### LLM å¦‚ä½•çŸ¥é“å¯ç”¨æŠ€èƒ½ï¼Ÿ

**Context Builder** å°‡å¯ç”¨æŠ€èƒ½æ³¨å…¥æç¤ºè©ä¸­ï¼š

```
ä½ æ˜¯ä¸€å€‹ä»£ç†äººã€‚å¯ç”¨æŠ€èƒ½ï¼š
- buy_insurance: è³¼è²·æ´ªæ°´ä¿éšª (duration: int)
- elevate_house: åŠ é«˜æˆ¿å±‹ (åƒ…èƒ½ä½¿ç”¨ä¸€æ¬¡)
- relocate: é·ç§»åˆ°æ›´å®‰å…¨çš„å€åŸŸ (æ°¸ä¹…)
- do_nothing: ä»Šå¹´ä¸æ¡å–ä»»ä½•è¡Œå‹•

è«‹ä»¥ JSON æ ¼å¼å›è¦†: {"skill": "...", "parameters": {...}, "reasoning": "..."}
```

é€™ç¢ºä¿ LLM åªæœƒæå‡ºå·²è¨»å†Šçš„æŠ€èƒ½ï¼Œç”± Skill Broker é€²è¡Œé©—è­‰ã€‚

### æ ¸å¿ƒåŸ·è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ä¸Šä¸‹æ–‡å»ºæ§‹                                                       â”‚
â”‚     StateManager â†’ ContextBuilder                                   â”‚
â”‚     â€¢ è®€å–ä»£ç†äººå€‹äººç‹€æ…‹ (memory, has_insurance ç­‰)                  â”‚
â”‚     â€¢ è®€å–å…±äº«ç‹€æ…‹ (flood_occurred, year)                           â”‚
â”‚     â€¢ å°‡å¯ç”¨æŠ€èƒ½æ³¨å…¥æç¤ºè©                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. LLM æ±ºç­–                                                        â”‚
â”‚     ContextBuilder â†’ LLM                                            â”‚
â”‚     â€¢ LLM æ¥æ”¶æœ‰ç•Œä¸Šä¸‹æ–‡ + æŠ€èƒ½åˆ—è¡¨                                  â”‚
â”‚     â€¢ LLM è¼¸å‡º SkillProposal JSON                                   â”‚
â”‚     â€¢ {"skill": "buy_insurance", "parameters": {...}, ...}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. é©—è­‰                                                            â”‚
â”‚     ModelAdapter â†’ SkillBrokerEngine â†’ Validators                   â”‚
â”‚     â€¢ å°‡ LLM è¼¸å‡ºè§£æç‚ºçµæ§‹åŒ– SkillProposal                          â”‚
â”‚     â€¢ Admissibility: æŠ€èƒ½æ˜¯å¦å·²è¨»å†Šï¼Ÿä»£ç†äººæ˜¯å¦æœ‰è³‡æ ¼ï¼Ÿ              â”‚
â”‚     â€¢ Feasibility: å‰ç½®æ¢ä»¶æ˜¯å¦æ»¿è¶³ï¼Ÿ(å°šæœªåŠ é«˜)                      â”‚
â”‚     â€¢ Constraints: å¹´åº¦é™åˆ¶ï¼Ÿä¸€æ¬¡æ€§è¦å‰‡ï¼Ÿ                           â”‚
â”‚     â€¢ è‹¥ç„¡æ•ˆ â†’ é€€å›åˆ° "do_nothing"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. åŸ·è¡Œèˆ‡ç‹€æ…‹æ›´æ–°                                                   â”‚
â”‚     SkillBrokerEngine â†’ Executor â†’ StateManager                     â”‚
â”‚     â€¢ åŸ·è¡Œå·²é©—è­‰çš„æŠ€èƒ½æ•ˆæœ                                          â”‚
â”‚     â€¢ æ›´æ–°ä»£ç†äººå€‹äººç‹€æ…‹                                            â”‚
â”‚     â€¢ è¨˜éŒ„åˆ° AuditWriter ä»¥ç¢ºä¿å¯è¿½æº¯æ€§                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¶æ§‹

### å–®ä»£ç†äººæ¨¡å¼

![å–®ä»£ç†äººæ¶æ§‹](docs/single_agent_architecture.png)

**æµç¨‹**: ç’°å¢ƒ â†’ Context Builder â†’ LLM â†’ Model Adapter â†’ Skill Broker Engine â†’ Validators â†’ Executor â†’ State

### å¤šä»£ç†äººæ¨¡å¼

![å¤šä»£ç†äººæ¶æ§‹](docs/multi_agent_architecture.png)

**æµç¨‹**: Agents â†’ LLM (Skill Proposal) â†’ Governed Broker Layer (Context Builder + Validators) â†’ State Managerï¼ŒåŒ…å«å››å±¤ï¼šIndividual (memory)ã€Social (é„°å±…è§€å¯Ÿ)ã€Shared (ç’°å¢ƒ)ã€Institutional (æ”¿ç­–è¦å‰‡)ã€‚

---

## å¿«é€Ÿé–‹å§‹

```bash
# å®‰è£ä¾è³´
pip install -r requirements.txt

# åŸ·è¡Œç¯„ä¾‹å¯¦é©—
cd examples/skill_governed_flood
python run_experiment.py --model llama3.2:3b --num-agents 100 --num-years 10
```

---

## æ¡†æ¶æ¼”é€²

![æ¡†æ¶æ¼”é€²](docs/framework_evolution.png)

**No MCP â†’ MCP v1 â†’ Skill-Governed (v2)**: æ¼¸é€²å¼å¢åŠ æ²»ç†å±¤ä»¥å¯¦ç¾å¯é çš„ LLM-ABM æ•´åˆã€‚

---

## æ ¸å¿ƒå…ƒä»¶

### Broker å±¤ (`broker/`)

| å…ƒä»¶ | æª”æ¡ˆ | èªªæ˜ |
|------|------|------|
| `SkillBrokerEngine` | `skill_broker_engine.py` | ä¸»è¦å”èª¿å™¨ï¼šé©—è­‰æŠ€èƒ½ã€ç®¡ç†åŸ·è¡Œç®¡ç·š |
| `SkillRegistry` | `skill_registry.py` | æŠ€èƒ½å®šç¾©åŠä»£ç†äººé¡å‹è³‡æ ¼å’Œåƒæ•¸çµæ§‹ |
| `ContextBuilder` | `context_builder.py` | å¾ç‹€æ…‹å»ºæ§‹æœ‰ç•Œä¸Šä¸‹æ–‡ï¼ŒåŒ…å«é„°å±…è§€å¯Ÿ |
| `ModelAdapter` | `model_adapter.py` | å°‡ LLM è¼¸å‡ºè§£æç‚ºçµæ§‹åŒ– SkillProposal |
| `AuditWriter` | `audit_writer.py` | å®Œæ•´å¯©è¨ˆè»Œè·¡ä»¥ç¢ºä¿å¯é‡ç¾æ€§ |

### State å±¤ (`simulation/`)

| å…ƒä»¶ | æª”æ¡ˆ | èªªæ˜ |
|------|------|------|
| `StateManager` | `state_manager.py` | å¤šå±¤ç‹€æ…‹: Individual / Social / Shared / Institutional |
| `SimulationEngine` | `engine.py` | ABM æ¨¡æ“¬è¿´åœˆåŠæŠ€èƒ½åŸ·è¡Œ |

### Provider å±¤ (`providers/`)

| å…ƒä»¶ | æª”æ¡ˆ | èªªæ˜ |
|------|------|------|
| `OllamaProvider` | `ollama.py` | é è¨­ LLM æä¾›è€… (æœ¬åœ° Ollama) |
| `OpenAIProvider` | `openai_provider.py` | OpenAI API æä¾›è€… |
| `ProviderFactory` | `factory.py` | å‹•æ…‹æä¾›è€…å¯¦ä¾‹åŒ– |
| `RateLimiter` | `rate_limiter.py` | API å‘¼å«é€Ÿç‡é™åˆ¶ |

### Validator å±¤ (`validators/`)

| å…ƒä»¶ | æª”æ¡ˆ | èªªæ˜ |
|------|------|------|
| `BaseValidator` | `base.py` | æŠ½è±¡é©—è­‰å™¨ä»‹é¢ |
| `SkillValidators` | `skill_validators.py` | 6 å€‹é©—è­‰å™¨: Admissibility, Feasibility, Constraints, Safety, PMT, Uncertainty |
| `ValidatorFactory` | `factory.py` | å¾ YAML å‹•æ…‹è¼‰å…¥é©—è­‰å™¨ |

---

## ç‹€æ…‹ç®¡ç†

### ç‹€æ…‹æ‰€æœ‰æ¬Š (å¤šä»£ç†äºº)

| ç‹€æ…‹é¡å‹ | ç¯„ä¾‹ | ç¯„åœ | è®€å– | å¯«å…¥ |
|----------|------|------|------|------|
| **Individual** | `memory`, `elevated`, `has_insurance` | ä»£ç†äººç§æœ‰ | åƒ…è‡ªå·± | åƒ…è‡ªå·± |
| **Social** | `neighbor_actions`, `last_decisions` | å¯è§€å¯Ÿé„°å±… | é„°å±… | ç³»çµ± |
| **Shared** | `flood_occurred`, `year` | æ‰€æœ‰ä»£ç†äºº | å…¨éƒ¨ | ç³»çµ± |
| **Institutional** | `subsidy_rate`, `policy_mode` | æ‰€æœ‰ä»£ç†äºº | å…¨éƒ¨ | åƒ…æ”¿åºœ |

> **é‡é»**: `memory` æ˜¯ **Individual** - æ¯å€‹ä»£ç†äººæœ‰è‡ªå·±çš„è¨˜æ†¶ï¼Œä¸å…±äº«ã€‚

---

## é©—è­‰ç®¡ç·š

| éšæ®µ | é©—è­‰å™¨ | æª¢æŸ¥ |
|------|--------|------|
| 1 | Admissibility | æŠ€èƒ½å­˜åœ¨ï¼Ÿä»£ç†äººæœ‰è³‡æ ¼ä½¿ç”¨æ­¤æŠ€èƒ½ï¼Ÿ |
| 2 | Feasibility | å‰ç½®æ¢ä»¶æ»¿è¶³ï¼Ÿ(ä¾‹å¦‚ï¼Œå°šæœªåŠ é«˜) |
| 3 | Constraints | ä¸€æ¬¡æ€§ï¼Ÿå¹´åº¦é™åˆ¶ï¼Ÿ |
| 4 | Effect Safety | ç‹€æ…‹è®Šæ›´æœ‰æ•ˆï¼Ÿ |
| 5 | PMT Consistency | æ¨ç†èˆ‡æ±ºç­–ä¸€è‡´ï¼Ÿ |
| 6 | Uncertainty | å›æ‡‰æœ‰ä¿¡å¿ƒï¼Ÿ |

---

## æ¡†æ¶æ¯”è¼ƒ

| ç¶­åº¦ | å–®ä»£ç†äºº | å¤šä»£ç†äºº |
|------|----------|----------|
| ç‹€æ…‹ | åƒ… Individual | Individual + Social + Shared + Institutional |
| ä»£ç†äººé¡å‹ | 1 ç¨® | N ç¨® (å±…æ°‘ã€æ”¿åºœã€ä¿éšªå…¬å¸) |
| å¯è§€å¯Ÿ | åƒ…è‡ªå·± | è‡ªå·± + é„°å±… + ç¤¾å€çµ±è¨ˆ |
| ä¸Šä¸‹æ–‡ | ç›´æ¥ | é€é Context Builder + Social Module |
| ä½¿ç”¨æ¡ˆä¾‹ | åŸºç¤ ABM | å…·ç¤¾æœƒå‹•æ…‹çš„æ”¿ç­–æ¨¡æ“¬ |

---

## æ–‡ä»¶

- [æ¶æ§‹è©³æƒ…](docs/skill_architecture.md)
- [è‡ªè¨‚æŒ‡å—](docs/customization_guide.md)
- [å¯¦é©—è¨­è¨ˆ](docs/experiment_design_guide.md)

---

## æˆæ¬Š

MIT
