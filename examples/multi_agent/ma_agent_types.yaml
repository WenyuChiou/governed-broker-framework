# =============================================================================
# SHARED DEFINITIONS
# =============================================================================
shared:
  rating_scale: "VL=Very Low, L=Low, M=Medium, H=High, VH=Very High"
  criteria_definitions: |
    - TP (Threat Perception): Assessment of flood risk and potential severity.
    - CP (Coping Perception): Ability to afford and implement protective measures.
    - SP (Stakeholder Perception): Trust in government grants and insurance reliability.
    - SC (Social Capital): Influence of neighbor actions and community support.
    - PA (Place Attachment): Emotional bond and belonging to the current home.

  # Default format for simple institutional decisions
  response_format:
    delimiter_start: "<<<DECISION_START>>>"
    delimiter_end: "<<<DECISION_END>>>"
    fields:
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }

# =============================================================================
# HOUSEHOLD AGENT TYPES
# =============================================================================
household_owner:
  description: "Homeowners making adaptation decisions."
  response_format:
    fields:
      - {
          key: "threat_perception",
          type: "appraisal",
          required: true,
          construct: "TP_LABEL",
        }
      - {
          key: "coping_perception",
          type: "appraisal",
          required: true,
          construct: "CP_LABEL",
        }
      - {
          key: "stakeholder_perception",
          type: "appraisal",
          required: true,
          construct: "SP_LABEL",
        }
      - {
          key: "social_capital",
          type: "appraisal",
          required: true,
          construct: "SC_LABEL",
        }
      - {
          key: "place_attachment",
          type: "appraisal",
          required: true,
          construct: "PA_LABEL",
        }
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }
  prompt_template: |
    You are a homeowner (Agent ID: {agent_id}). {narrative_persona}
    You have lived here for {residency_generations} generations. Your income is {income_range}.

    Experience: {flood_experience_summary}
    Recent memory: {memory}
    Property status: {elevation_status_text}
    Insurance: You Currently {insurance_status} flood insurance.
    Current Costs: Annual premium is ${current_premium:,.0f} and subsidy rate is {subsidy_rate:.0%}.

    Please evaluate your situation based on these criteria:
    {criteria_definitions}

    Consider these options:
    {options_text}

    Rating Scale: {rating_scale}

    Respond only using the exact JSON format below. Do NOT include conversational text.
    {response_format}

  parsing:
    decision_keywords: ["decision"]
    default_skill: "do_nothing"
    full_disclosure: true
    strict_mode: true
    skill_map_non_elevated:
      "1": "do_nothing"
      "2": "buy_insurance"
      "3": "elevate_house"
      "4": "buyout_program"
    skill_map_elevated:
      "1": "do_nothing"
      "2": "buy_insurance"
      "3": "buyout_program"
    constructs:
      TP_LABEL:
        { keywords: ["threat_perception"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      TP_REASON: { keywords: ["threat_perception"], regex: ".*" }
      CP_LABEL:
        { keywords: ["coping_perception"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      CP_REASON: { keywords: ["coping_perception"], regex: ".*" }
      SP_LABEL:
        {
          keywords: ["stakeholder_perception"],
          regex: "(?i)\\b(VL|L|M|H|VH)\\b",
        }
      SP_REASON: { keywords: ["stakeholder_perception"], regex: ".*" }
      SC_LABEL:
        { keywords: ["social_capital"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      SC_REASON: { keywords: ["social_capital"], regex: ".*" }
      PA_LABEL:
        { keywords: ["place_attachment"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      PA_REASON: { keywords: ["place_attachment"], regex: ".*" }
  log_fields:
    [
      "threat_perception",
      "coping_perception",
      "stakeholder_perception",
      "social_capital",
      "place_attachment",
    ]

household_renter:
  description: "Renters making adaptation decisions."
  response_format:
    fields:
      - {
          key: "threat_perception",
          type: "appraisal",
          required: true,
          construct: "TP_LABEL",
        }
      - {
          key: "coping_perception",
          type: "appraisal",
          required: true,
          construct: "CP_LABEL",
        }
      - {
          key: "stakeholder_perception",
          type: "appraisal",
          required: true,
          construct: "SP_LABEL",
        }
      - {
          key: "social_capital",
          type: "appraisal",
          required: true,
          construct: "SC_LABEL",
        }
      - {
          key: "place_attachment",
          type: "appraisal",
          required: true,
          construct: "PA_LABEL",
        }
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }
  log_fields:
    [
      "threat_perception",
      "coping_perception",
      "stakeholder_perception",
      "social_capital",
      "place_attachment",
    ]

  prompt_template: |
    You are a renter (Agent ID: {agent_id}).
    You have lived here for {residency_generations} years. Your income is {income_range}.

    Experience: {flood_experience_summary} | Memory: {memory}
    Insurance: You Currently {insurance_status} flood insurance.

    Criteria to consider:
    {criteria_definitions}

    Options:
    {options_text}

    Rating Scale: {rating_scale}

    Respond only using the exact JSON format below:
    {response_format}

  parsing:
    decision_keywords: ["decision"]
    default_skill: "do_nothing"
    full_disclosure: true
    strict_mode: true
    skill_map:
      { "1": "do_nothing", "2": "buy_contents_insurance", "3": "relocate" }
    constructs:
      TP_LABEL:
        { keywords: ["threat_perception"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      CP_LABEL:
        { keywords: ["coping_perception"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      SP_LABEL:
        {
          keywords: ["stakeholder_perception"],
          regex: "(?i)\\b(VL|L|M|H|VH)\\b",
        }
      SC_LABEL:
        { keywords: ["social_capital"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      PA_LABEL:
        { keywords: ["place_attachment"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }

government:
  description: "State Government Agency."
  prompt_template: |
    You are the State Government Agency. Year: {year}.
    Institutional Context: Subsidy Rate: {subsidy_rate:.0%} | Elevated: {elevated_count}/{total_households}
    Task: Choose 1:INCREASE | 2:DECREASE | 3:MAINTAIN subsidy.

    {response_format}
  parsing:
    decision_keywords: ["decision"]
    default_skill: "maintain_subsidy"
    skill_map:
      {
        "1": "increase_subsidy",
        "2": "decrease_subsidy",
        "3": "maintain_subsidy",
      }

insurance:
  description: "Regional Insurance Marketer."
  prompt_template: |
    You are the Regional Insurance Marketer.
    Market Stats: Loss Ratio: {loss_ratio:.2f} | Insured Base: {insured_count}
    Task: Choose 1:RAISE | 2:LOWER | 3:MAINTAIN premium rates.

    {response_format}
  parsing:
    decision_keywords: ["decision"]
    default_skill: "maintain_premium"
    skill_map:
      { "1": "raise_premium", "2": "lower_premium", "3": "maintain_premium" }

# =============================================================================
# GOVERNANCE RULES
# =============================================================================
governance:
  strict:
    household_owner:
      identity_rules:
        - {
            id: elevated_already,
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: ERROR,
          }
        - {
            id: relocated_already,
            precondition: relocated,
            blocked_skills:
              ["buy_insurance", "elevate_house", "buyout_program"],
            level: ERROR,
          }
      thinking_rules:
        - {
            construct: TP_LABEL,
            when_above: ["VH"],
            blocked_skills: ["do_nothing"],
            level: ERROR,
          }
        - {
            construct: CP_LABEL,
            when_above: ["VL"],
            blocked_skills: ["elevate_house", "buyout_program"],
            level: ERROR,
          }
    household_renter:
      identity_rules:
        - {
            id: relocated_already,
            precondition: relocated,
            blocked_skills: ["buy_contents_insurance", "relocate"],
            level: ERROR,
          }

metadata: { version: "v23-finalized-robust-universal" }
