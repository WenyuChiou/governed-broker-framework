# =============================================================================
# SHARED DEFINITIONS
# =============================================================================
shared:
  rating_scale: "VL=Very Low, L=Low, M=Medium, H=High, VH=Very High"
  criteria_definitions: |
    Protection Motivation Theory (PMT) Constructs:
    - TP (Threat Perception): How serious do you perceive the flood risk? Consider likelihood and potential severity.
    - CP (Coping Perception): How confident are you that mitigation options (insurance, elevation, buyout) are effective and affordable?
    - SP (Stakeholder Perception): How much do you trust institutions (NJDEP, FEMA/NFIP) to provide reliable support?
    - SC (Social Capital): How connected are you with neighbors? Are they taking protective actions?
    - PA (Place Attachment): How emotionally attached are you to your home and community?

  response_format:
    delimiter_start: "<<<DECISION_START>>>"
    delimiter_end: "<<<DECISION_END>>>"
    fields:
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }

# =============================================================================
# HOUSEHOLD AGENT TYPES (PMT-based)
# =============================================================================
household_owner:
  description: "Homeowner household agent in Passaic River Basin, NJ."
  llm_params:
    num_ctx: 16384
    num_predict: 2048
  response_format:
    fields:
      - { key: "threat_perception", type: "appraisal", required: true, construct: "TP_LABEL" }
      - { key: "coping_perception", type: "appraisal", required: true, construct: "CP_LABEL" }
      - { key: "stakeholder_perception", type: "appraisal", required: true, construct: "SP_LABEL" }
      - { key: "social_capital", type: "appraisal", required: true, construct: "SC_LABEL" }
      - { key: "place_attachment", type: "appraisal", required: true, construct: "PA_LABEL" }
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }
  prompt_template: |
    You are a homeowner (Agent ID: {agent_id}) in the Passaic River Basin, New Jersey.

    ### YOUR SITUATION
    - Income: {income_range}
    - Household Size: {household_size} people
    - Generations in Area: {residency_generations}
    - Flood Zone: {flood_zone} (depth: {flood_depth:.2f}m)
    - Flood Experience: {flood_experience_summary}
    - Property Value: ${rcv_building:,.0f} (building) + ${rcv_contents:,.0f} (contents)
    - Current Status: {elevation_status_text}
    - Insurance: You currently {insurance_status} flood insurance.

    ### RELEVANT MEMORIES
    {memory}

    ### POLICY UPDATES THIS YEAR
    - NJ Government (NJDEP Blue Acres): {govt_message}
    - FEMA/NFIP Insurance: {insurance_message}

    ### CURRENT COSTS
    - Annual NFIP Premium: ${current_premium:,.0f}
    - Elevation Subsidy Rate: {subsidy_rate:.0%}

    ### ADAPTATION OPTIONS
    {options_text}

    ### EVALUATION CRITERIA
    {criteria_definitions}

    Rating Scale: {rating_scale}

    Based on your situation and PMT profile, evaluate each criterion and make your decision.
    Respond ONLY with valid JSON in this format:
    {response_format}

  parsing:
    actions:
      - id: do_nothing
        aliases: ["DN", "nothing", "wait", "Do nothing", "Do Nothing", "Take no action", "[DN]"]
        description: "Take no action this year"
      - id: buy_insurance
        aliases: ["FI", "insurance", "buy_insurance", "Buy insurance", "Purchase flood insurance", "[FI]"]
        description: "Purchase NFIP flood insurance"
      - id: elevate_house
        aliases: ["HE", "elevate", "elevation", "elevate_house", "Elevate house", "[HE]"]
        description: "Elevate house structure (with subsidy)"
      - id: buyout_program
        aliases: ["BT", "buyout", "Blue Acres", "Accept buyout", "[BT]"]
        description: "Accept NJ Blue Acres buyout"
    constructs:
      TP_LABEL: { keywords: ["threat", "severity", "vulnerability"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      TP_REASON: { keywords: ["threat", "severity", "vulnerability"], regex: "(?i)(?:reason|why|because|explanation)[:\\s\\*]*(.*)" }
      CP_LABEL: { keywords: ["coping", "efficacy", "ability"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      CP_REASON: { keywords: ["coping", "efficacy", "ability"], regex: "(?i)(?:reason|why|because|explanation)[:\\s\\*]*(.*)" }
      SP_LABEL: { keywords: ["stakeholder", "trust", "government", "insurance"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      SP_REASON: { keywords: ["stakeholder", "trust", "government", "insurance"], regex: "(?i)(?:reason|why|because|explanation)[:\\s\\*]*(.*)" }
      SC_LABEL: { keywords: ["social", "neighbor", "community"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      SC_REASON: { keywords: ["social", "neighbor", "community"], regex: "(?i)(?:reason|why|because|explanation)[:\\s\\*]*(.*)" }
      PA_LABEL: { keywords: ["place", "attachment", "belonging"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      PA_REASON: { keywords: ["place", "attachment", "belonging"], regex: "(?i)(?:reason|why|because|explanation)[:\\s\\*]*(.*)" }
  log_fields: ["threat_perception", "coping_perception", "stakeholder_perception", "social_capital", "place_attachment"]

household_renter:
  description: "Renter household agent in Passaic River Basin, NJ."
  llm_params:
    num_ctx: 16384
    num_predict: 2048
  response_format:
    fields:
      - { key: "threat_perception", type: "appraisal", required: true, construct: "TP_LABEL" }
      - { key: "coping_perception", type: "appraisal", required: true, construct: "CP_LABEL" }
      - { key: "stakeholder_perception", type: "appraisal", required: true, construct: "SP_LABEL" }
      - { key: "social_capital", type: "appraisal", required: true, construct: "SC_LABEL" }
      - { key: "place_attachment", type: "appraisal", required: true, construct: "PA_LABEL" }
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }
  log_fields: ["threat_perception", "coping_perception", "stakeholder_perception", "social_capital", "place_attachment"]

  prompt_template: |
    You are a renter (Agent ID: {agent_id}) in the Passaic River Basin, New Jersey.

    ### YOUR SITUATION
    - Income: {income_range}
    - Household Size: {household_size} people
    - Years at Current Address: {residency_generations}
    - Flood Zone: {flood_zone} (depth: {flood_depth:.2f}m)
    - Flood Experience: {flood_experience_summary}
    - Contents Value: ${rcv_contents:,.0f}
    - Insurance: You currently {insurance_status} contents flood insurance.

    ### YOUR PSYCHOLOGICAL PROFILE (Protection Motivation Theory)
    Based on your survey responses:
    - Threat Perception (TP): {tp_score:.1f}/5 - {tp_rating}
    - Coping Perception (CP): {cp_score:.1f}/5 - {cp_rating}
    - Stakeholder Perception (SP): {sp_score:.1f}/5 - {sp_rating}
    - Social Capital (SC): {sc_score:.1f}/5 - {sc_rating}
    - Place Attachment (PA): {pa_score:.1f}/5 - {pa_rating}

    ### RELEVANT MEMORIES
    {memory}

    ### POLICY UPDATES THIS YEAR
    - NJ Government: {govt_message}
    - FEMA/NFIP: {insurance_message}

    ### ADAPTATION OPTIONS (as a renter)
    {options_text}

    Note: As a renter, you cannot elevate the property or accept a buyout.
    Your options are limited to contents insurance, relocation, or no action.

    ### EVALUATION CRITERIA
    {criteria_definitions}

    Rating Scale: {rating_scale}

    Respond ONLY with valid JSON:
    {response_format}

  parsing:
    actions:
      - id: do_nothing
        aliases: ["DN", "nothing", "wait", "Do nothing", "Do Nothing", "Take no action", "[DN]"]
        description: "Take no action this year"
      - id: buy_contents_insurance
        aliases: ["CI", "contents_insurance", "Buy contents insurance", "insurance", "[CI]"]
        description: "Purchase NFIP contents-only flood insurance"
      - id: relocate
        aliases: ["RL", "move", "relocate", "Relocation", "Move", "[RL]"]
        description: "Relocate to lower flood-risk area"

    constructs:
      TP_LABEL: { keywords: ["threat", "severity", "vulnerability"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      CP_LABEL: { keywords: ["coping", "efficacy", "ability"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      SP_LABEL: { keywords: ["stakeholder", "trust", "government", "insurance"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      SC_LABEL: { keywords: ["social", "neighbor", "community"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }
      PA_LABEL: { keywords: ["place", "attachment", "belonging"], regex: "(?i)(?:label)?[:\\s\\*\\[]*\\b(VL|L|M|H|VH)\\b" }

# =============================================================================
# NJ GOVERNMENT AGENT (NJDEP Blue Acres)
# =============================================================================
nj_government:
  description: "New Jersey Department of Environmental Protection - Blue Acres Buyout Program"
  llm_params:
    num_ctx: 16384
    num_predict: 1024
  prompt_template: |
    ### IDENTITY
    You are the New Jersey Department of Environmental Protection (NJDEP),
    administering the Blue Acres Floodplain Buyout Program and elevation subsidies
    for the Passaic River Basin communities.

    ### PROGRAM BACKGROUND
    The Blue Acres program is a voluntary buyout initiative that purchases
    flood-prone properties from willing sellers, converting them to open space.
    Elevation subsidies help homeowners raise structures above flood levels.

    ### CURRENT CONTEXT
    - Year: {year}
    - Current Elevation Subsidy Rate: {subsidy_rate:.0%}
    - Community Adaptation Status: {elevated_count} of {total_households} households elevated
    - Buyout Applications Pending: {buyout_pending}
    - Marginalized Group (MG) Households: {mg_count} ({mg_ratio:.0%})

    ### POLICY OPTIONS
    - [1] INCREASE_SUBSIDY: Raise elevation subsidy by 5% to encourage more adaptation
    - [2] DECREASE_SUBSIDY: Reduce subsidy by 5% to conserve budget
    - [3] MAINTAIN: Keep current subsidy rate unchanged

    ### OBJECTIVES (per NJ Environmental Justice guidelines)
    1. Reduce community flood risk through voluntary buyouts and elevation incentives
    2. Balance program budget with community needs
    3. Prioritize assistance to marginalized and repetitive-loss communities
    4. Support long-term community resilience

    ### RESPONSE FORMAT
    Respond ONLY with a valid JSON object:
    {
      "decision": "1",
      "reasoning": "Your policy rationale here"
    }
  response_format:
    fields:
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: true }
  parsing:
    decision_keywords: ["decision", "choice"]
    default_skill: "maintain_subsidy"
    strict_mode: false
    preprocessor: { type: "smart_repair" }
    actions:
      - id: increase_subsidy
        aliases: ["INCREASE", "increase", "INCREASE_SUBSIDY", "1", "[1]"]
        description: "Increase elevation subsidy by 5%"
      - id: decrease_subsidy
        aliases: ["DECREASE", "decrease", "DECREASE_SUBSIDY", "2", "[2]"]
        description: "Decrease elevation subsidy by 5%"
      - id: maintain_subsidy
        aliases: ["MAINTAIN", "maintain", "3", "[3]"]
        description: "Maintain current subsidy rate"

# Alias for backward compatibility
government:
  description: "State Government Agency (alias for nj_government)."
  llm_params:
    num_ctx: 16384
    num_predict: 1024
  prompt_template: |
    ### IDENTITY
    You are the New Jersey Department of Environmental Protection (NJDEP),
    administering the Blue Acres Floodplain Buyout Program and elevation subsidies.

    ### CURRENT CONTEXT
    - Year: {year}
    - Current Subsidy Rate: {subsidy_rate:.0%}
    - Community Status: {elevated_count} of {total_households} households are elevated.
    - MG Households: {mg_count} ({mg_ratio:.0%})

    ### OBJECTIVES
    1. Increase community resilience (more elevated houses).
    2. Manage budget responsibly.
    3. Prioritize marginalized communities per NJ environmental justice guidelines.

    ### TASK
    Decide whether to adjust the subsidy rate.
    Options:
    - [1] INCREASE: Boost subsidy (Current + 5%) to encourage more adaptation.
    - [2] DECREASE: Lower subsidy (Current - 5%) to save budget.
    - [3] MAINTAIN: Keep the current rate.

    ### RESPONSE FORMAT
    Respond ONLY with a valid JSON object:
    {
      "decision": "1",
      "reasoning": "Reason here"
    }
  response_format:
    fields:
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: true }
  parsing:
    decision_keywords: ["decision", "choice"]
    default_skill: "maintain_subsidy"
    strict_mode: false
    preprocessor: { type: "smart_repair" }
    actions:
      - id: increase_subsidy
        aliases: ["INCREASE", "increase", "1", "[1]"]
      - id: decrease_subsidy
        aliases: ["DECREASE", "decrease", "2", "[2]"]
      - id: maintain_subsidy
        aliases: ["MAINTAIN", "maintain", "3", "[3]"]

# =============================================================================
# FEMA/NFIP INSURANCE AGENT
# =============================================================================
fema_nfip:
  description: "Federal Emergency Management Agency - National Flood Insurance Program"
  llm_params:
    num_ctx: 16384
    num_predict: 1024
  prompt_template: |
    ### IDENTITY
    You are the FEMA National Flood Insurance Program (NFIP) regional administrator
    for the Passaic River Basin, implementing Risk Rating 2.0 pricing methodology.

    ### PROGRAM BACKGROUND
    The NFIP provides federally-backed flood insurance to property owners in
    participating communities. Risk Rating 2.0 (effective 2021) calculates
    individual property rates based on flood risk, replacement cost, and distance
    to water sources.

    ### MARKET STATISTICS
    - Current Average Premium Rate: {premium_rate:.3%} of coverage value
    - Insured Households: {insured_count} of {total_households}
    - Program Loss Ratio: {loss_ratio:.2f} (Target: 0.60-0.80)
    - Community Rating System (CRS) Discount: {crs_discount:.0%}
    - Recent Claims: {recent_claims} in past year

    ### POLICY OPTIONS
    - [1] RAISE_PREMIUM: Increase rates by 0.5% per Risk Rating 2.0 actuarial guidelines
    - [2] LOWER_PREMIUM: Reduce rates by 0.5% to improve affordability and take-up
    - [3] MAINTAIN: Keep current premium structure

    ### OBJECTIVES
    1. Maintain program solvency while ensuring affordability
    2. Encourage risk reduction through premium discounts for mitigation
    3. Support community resilience per FEMA's Building Resilient Infrastructure initiative
    4. Balance actuarial soundness with social equity considerations

    ### RESPONSE FORMAT
    Respond ONLY with a valid JSON object:
    {
      "decision": "1",
      "reasoning": "Your policy rationale here"
    }
  response_format:
    fields:
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: true }
  parsing:
    decision_keywords: ["decision", "choice"]
    default_skill: "maintain_premium"
    strict_mode: false
    preprocessor: { type: "smart_repair" }
    actions:
      - id: raise_premium
        aliases: ["RAISE", "raise", "RAISE_PREMIUM", "1", "[1]"]
        description: "Raise NFIP premium rate by 0.5%"
      - id: lower_premium
        aliases: ["LOWER", "lower", "LOWER_PREMIUM", "2", "[2]"]
        description: "Lower NFIP premium rate by 0.5%"
      - id: maintain_premium
        aliases: ["MAINTAIN", "maintain", "3", "[3]"]
        description: "Maintain current NFIP premium rate"

# Alias for backward compatibility
insurance:
  description: "Regional Insurance Marketer (alias for fema_nfip)."
  llm_params:
    num_ctx: 16384
    num_predict: 1024
  prompt_template: |
    ### IDENTITY
    You are the FEMA National Flood Insurance Program (NFIP) regional administrator,
    implementing Risk Rating 2.0 pricing methodology.

    ### MARKET STATS
    - Current Premium Rate: {premium_rate:.3%}
    - Insured Base: {insured_count} of {total_households} households.
    - Historical Profitability: Loss Ratio is {loss_ratio:.2f} (Target < 0.70).

    ### OBJECTIVES
    1. Maintain program solvency (Profitability).
    2. Maintain market share (Insured base).
    3. Encourage mitigation through premium discounts.

    ### TASK
    Decide whether to adjust premium rates.
    Options:
    - [1] RAISE: Increase premiums (+0.5%) to offset losses.
    - [2] LOWER: Decrease premiums (-0.5%) to attract more customers.
    - [3] MAINTAIN: Keep current premiums.

    ### RESPONSE FORMAT
    Respond ONLY with a valid JSON object:
    {
      "decision": "1",
      "reasoning": "Reason here"
    }
  response_format:
    fields:
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: true }
  parsing:
    decision_keywords: ["decision", "choice"]
    default_skill: "maintain_premium"
    strict_mode: false
    preprocessor: { type: "smart_repair" }
    actions:
      - id: raise_premium
        aliases: ["RAISE", "raise", "1", "[1]"]
      - id: lower_premium
        aliases: ["LOWER", "lower", "2", "[2]"]
      - id: maintain_premium
        aliases: ["MAINTAIN", "maintain", "3", "[3]"]

# =============================================================================
# GOVERNANCE RULES
# =============================================================================
governance:
  strict:
    household_owner:
      identity_rules:
        - { id: elevated_already, precondition: elevated, blocked_skills: ["elevate_house"], level: ERROR }
        - { id: relocated_already, precondition: relocated, blocked_skills: ["buy_insurance", "elevate_house", "buyout_program"], level: ERROR }
      thinking_rules:
        - { construct: TP_LABEL, when_above: ["VH"], blocked_skills: ["do_nothing"], level: ERROR }
        - { construct: CP_LABEL, when_above: ["VL"], blocked_skills: ["elevate_house", "buyout_program"], level: ERROR }
    household_renter:
      identity_rules:
        - { id: relocated_already, precondition: relocated, blocked_skills: ["buy_contents_insurance", "relocate"], level: ERROR }
    nj_government:
      identity_rules: []
      thinking_rules: []
    fema_nfip:
      identity_rules: []
      thinking_rules: []
    government:
      identity_rules: []
      thinking_rules: []
    insurance:
      identity_rules: []
      thinking_rules: []

metadata: { version: "v24-nj-fema-pmt-refactored" }
