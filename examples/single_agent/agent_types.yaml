# =============================================================================
# SHARED DEFINITIONS (Reusable across agent types)
# =============================================================================
shared:
  rating_scale: |
    ### RATING SCALE (You MUST use EXACTLY one of these codes):
    VL = Very Low | L = Low | M = Medium | H = High | VH = Very High

  # Response Format Definition (for ResponseFormatBuilder)
  response_format:
    delimiter_start: "<<<DECISION_START>>>"
    delimiter_end: "<<<DECISION_END>>>"
    fields:
      - {
          key: "threat_appraisal",
          type: "appraisal",
          required: true,
          construct: "TP_LABEL",
          reason_hint: "One sentence summary of how threatened you feel by any remaining flood risks.",
        }
      - {
          key: "coping_appraisal",
          type: "appraisal",
          required: true,
          construct: "CP_LABEL",
          reason_hint: "One sentence summary of how well you think you can cope or act.",
        }
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }

  # Centralized Retry Configuration
  governance:
    max_retries: 3
    max_reports_per_retry: 3
  llm:
    max_retries: 2

# =============================================================================
# HOUSEHOLD AGENT TYPE
# =============================================================================
household:
  description: "Household agents making adaptation decisions based on PMT"
  llm_params:
    num_ctx: 16384
    num_predict: 2048
    # Sampling parameters (uncomment to override Ollama defaults)
    # temperature: 1.0    # Higher = more diverse, Lower = more deterministic
    # top_p: 0.95         # Nucleus sampling threshold
    # top_k: 50           # Top-k sampling

  # Prompt Template (FINAL version aligned)
  prompt_template: |
    You are a homeowner in a city, with a strong attachment to your community. {elevation_status_text}
    Your memory includes:
    {memory}

    You currently {insurance_status} flood insurance.
    You {trust_insurance_text} the insurance company. You {trust_neighbors_text} your neighbors' judgment.

    Using the Protection Motivation Theory, evaluate your current situation by considering the following factors:
    - Perceived Severity: How serious the consequences of flooding feel to you.
    - Perceived Vulnerability: How likely you think you are to be affected.
    - Response Efficacy: How effective you believe each action is.
    - Self-Efficacy: Your confidence in your ability to take that action.
    - Response Cost: The financial and emotional cost of the action.
    - Maladaptive Rewards: The benefit of doing nothing immediately.

    Now, choose one of the following actions:
    {options_text}
    Note: If no flood occurred this year, since no immediate threat, most people would choose ?Do Nothing.??

    {rating_scale}

    Please respond using the EXACT JSON format below.
    - IMPORTANT: The "decision" field MUST be the NUMERIC ID (e.g. 1, 2, 3, or 4) from the available options list.
    - Do NOT include any markdown symbols (like ```json), conversational text, or explanations outside the JSON.

    - Use EXACTLY one of: VL, L, M, H, VH for each appraisal label.
    - Ensure all keys match the format exactly.

    {response_format}

  # Parsing & Skill Mapping
  parsing:
    decision_keywords: ["decision", "choice", "action", "selected_action"]
    default_skill: "do_nothing"
    global_skills: ["do_nothing", "buy_insurance", "buy_contents_insurance"]
    full_disclosure: true
    strict_mode: true
    preprocessor:
      { type: "smart_repair", quote_values: ["VL", "L", "M", "H", "VH"] }

    # Audit Keywords (Domain-specific keywords moved here from code)
    audit_keywords:
      [
        "flood",
        "water",
        "damage",
        "cost",
        "neighbor",
        "money",
        "safe",
        "protect",
        "elevation",
        "insurance",
        "loss",
      ]
    # Context fields to extract for demographic grounding audit
    audit_context_fields: ["narrative_persona", "flood_experience_summary"]
    # Domain-specific stopwords (added to generic English stopwords)
    audit_blacklist:
      [
        "flood",
        "floods",
        "flooding",
        "risk",
        "water",
        "manageable",
        "resident",
        "household",
      ]
    audit_stopwords: ["flood", "floods", "flooding", "risk", "water"]

    # Synonym Mapping for Construct Extraction (Domain-specific, moved from code)
    synonyms:
      tp:
        [
          "severity",
          "vulnerability",
          "threat",
          "risk",
          "danger",
          "perceived_severity",
          "perceived_vulnerability",
          "consequence",
          "impact",
          "seriousness",
        ]
      cp:
        [
          "efficacy",
          "self_efficacy",
          "response_efficacy",
          "coping",
          "ability",
          "effectiveness",
          "response_cost",
          "preparedness",
          "capacity",
          "suitability",
        ]

    # Baseline Skill Mapping (numeric 1-4)
    skill_map:
      "1": "buy_insurance"
      "2": "elevate_house"
      "4": "relocate"
      "3": "do_nothing"

    skill_map_elevated:
      "1": "buy_insurance"
      "2": "relocate"
      "3": "do_nothing"

    # Construct mappings (Robust Regex for the "M" issue)
    constructs:
      TP_LABEL:
        {
          keywords: ["threat_appraisal", "threat"],
          regex: "(?i)\\b(VL|L|M|H|VH)\\b",
        }
      TP_REASON: { keywords: ["threat_appraisal", "threat"], regex: ".*" }
      CP_LABEL:
        {
          keywords: ["coping_appraisal", "coping"],
          regex: "(?i)\\b(VL|L|M|H|VH)\\b",
        }
      CP_REASON: { keywords: ["coping_appraisal", "coping"], regex: ".*" }

  log_fields: ["threat_appraisal", "coping_appraisal"]

  # Human-Centric Memory Configuration
  memory:
    engine_type: "human_centric"
    window_size: 5
    top_k_significant: 2
    emotion_keywords:
      critical: ["flood", "flooded", "damage", "destroyed", "loss", "trauma"]
      major: ["decision", "grant", "relocate", "elevate", "move"]
      positive: ["protected", "safe", "insurance", "saved", "relief"]
      shift: ["trust", "neighbor", "judgment", "observe"]
    source_patterns:
      personal: ["i ", "my ", "me ", "got flooded", "my house"]
      neighbor: ["neighbor", "others", "friend"]
      community: ["%", "residents", "community", "everyone"]
    emotional_weights:
      critical: 1.0
      major: 0.8
      positive: 0.6
      shift: 0.4
      observation: 0.2
      routine: 0.1
    source_weights:
      personal: 1.0
      neighbor: 0.8
      community: 0.6
      abstract: 0.4

  # Available Actions (mapped to Skill Registry IDs)
  actions:
    - id: buy_insurance
      aliases:
        [
          "FI",
          "insurance",
          "buy_insurance",
          "buy flood insurance",
          "Buy flood insurance",
          "[FI]",
          "[insurance]",
          "[buy_insurance]",
          "[buy flood insurance]",
          "[Buy flood insurance]",
        ]
      description: "Buy flood insurance (Lower cost, provides partial financial protection but does not reduce physical damage.)"
    - id: elevate_house
      aliases:
        [
          "HE",
          "elevate",
          "elevation",
          "elevate_house",
          "elevate house",
          "Elevate your house",
          "Elevate house",
          "[HE]",
          "[elevate]",
          "[elevation]",
          "[elevate_house]",
          "[elevate house]",
          "[Elevate your house]",
          "[Elevate house]",
        ]
      description: "Elevate your house (High upfront cost but can prevent most physical damage.)"
    - id: relocate
      aliases:
        [
          "RL",
          "move",
          "relocate",
          "Relocate",
          "[RL]",
          "[move]",
          "[relocate]",
          "[Relocate]",
        ]
      description: "Relocate (Requires leaving your neighborhood but eliminates flood risk permanently.)"
    - id: do_nothing
      aliases:
        [
          "DN",
          "nothing",
          "wait",
          "do_nothing",
          "Do nothing",
          "Do Nothing",
          "[DN]",
          "[nothing]",
          "[wait]",
          "[do_nothing]",
          "[Do nothing]",
          "[Do Nothing]",
        ]
      description: "Do nothing (Require no financial investment or effort this year, but it might leave you exposed to future flood damage.)"

  # Governance Profiles
  governance:
    strict:
      thinking_rules:
        - {
            construct: TP_LABEL,
            when_above: ["VH"],
            blocked_skills: ["do_nothing"],
            level: ERROR,
          }
        # Realism Rule: Block complex actions if self-efficacy (Coping) is too low
        - {
            construct: CP_LABEL,
            conditions: [{ construct: CP_LABEL, values: ["VL"] }],
            blocked_skills: ["elevate_house", "relocate"],
            level: ERROR,
            message: "Action blocked due to extremely low perceived capability (Self-efficacy).",
          }
        - {
            id: relocation_threat_low,
            conditions: [{ construct: TP_LABEL, values: ["VL", "L"] }],
            blocked_skills: ["relocate"],
            level: ERROR,
          }
        - {
            id: elevation_threat_low,
            conditions: [{ construct: TP_LABEL, values: ["VL", "L"] }],
            blocked_skills: ["elevate_house"],
            level: ERROR,
          }
      identity_rules:
        - {
            id: elevation_block,
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: ERROR,
          }

    relaxed:
      thinking_rules:
        - {
            construct: TP_LABEL,
            when_above: ["H"],
            blocked_skills: ["do_nothing"],
            level: WARNING,
          }
      identity_rules:
        - {
            id: elevation_block,
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: WARNING,
          }

metadata: { version: "v22-sa-final-parity-robust" }
