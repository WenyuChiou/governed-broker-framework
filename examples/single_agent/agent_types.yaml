# =============================================================================
# SHARED DEFINITIONS (Reusable across agent types)
# =============================================================================
shared:
  rating_scale: |
    ### RATING SCALE (You MUST use EXACTLY one of these codes):
    VL = Very Low | L = Low | M = Medium | H = High | VH = Very High

  # Response Format Definition (for ResponseFormatBuilder)
  response_format:
    delimiter_start: "<<<DECISION_START>>>"
    delimiter_end: "<<<DECISION_END>>>"
    fields:
      - {
          key: "threat_appraisal",
          type: "appraisal",
          required: true,
          construct: "TP_LABEL",
          reason_hint: "One sentence summary of how threatened you feel by any remaining flood risks.",
        }
      - {
          key: "coping_appraisal",
          type: "appraisal",
          required: true,
          construct: "CP_LABEL",
          reason_hint: "One sentence summary of how well you think you can cope or act.",
        }
      - { key: "decision", type: "choice", required: true }
      - { key: "reasoning", type: "text", required: false }

# =============================================================================
# HOUSEHOLD AGENT TYPE
# =============================================================================
household:
  description: "Household agents making adaptation decisions based on PMT"

  # Prompt Template (FINAL version aligned)
  prompt_template: |
    You are a homeowner in a city, with a strong attachment to your community. {elevation_status_text}
    Your memory includes:
    {memory}

    You currently {insurance_status} flood insurance.
    You {trust_insurance_text} the insurance company. You {trust_neighbors_text} your neighbors' judgment.

    Using the Protection Motivation Theory, evaluate your current situation by considering the following factors:
    - Perceived Severity: How serious the consequences of flooding feel to you.
    - Perceived Vulnerability: How likely you think you are to be affected.
    - Response Efficacy: How effective you believe each action is.
    - Self-Efficacy: Your confidence in your ability to take that action.
    - Response Cost: The financial and emotional cost of the action.
    - Maladaptive Rewards: The benefit of doing nothing immediately.

    Now, choose one of the following actions:
    {options_text}
    Note: If no flood occurred this year, since no immediate threat, most people would choose ?Do Nothing.??

    {rating_scale}

    Please respond using the exact JSON format below. Do NOT include any markdown symbols or conversational text.
    Use EXACTLY one of: VL, L, M, H, VH for each label.

    <<<DECISION_START>>>
    {{
      "threat_appraisal": {{"label": "VL/L/M/H/VH", "reason": "One sentence summary of how threatened you feel by any remaining flood risks."}},
      "coping_appraisal": {{"label": "VL/L/M/H/VH", "reason": "One sentence summary of how well you think you can cope or act."}},
      "decision": {valid_choices_text},
      "reasoning": "Overall justification for your action."
    }}
    <<<DECISION_END>>>

  # Parsing & Skill Mapping
  parsing:
    decision_keywords: ["decision"]
    default_skill: "do_nothing"
    global_skills: ["do_nothing", "buy_insurance", "buy_contents_insurance"]
    full_disclosure: true
    strict_mode: true

    # Baseline Skill Mapping (numeric 1-4)
    skill_map_non_elevated:
      "1": "buy_insurance"
      "2": "elevate_house"
      "3": "relocate"
      "4": "do_nothing"

    skill_map_elevated:
      "1": "buy_insurance"
      "2": "relocate"
      "3": "do_nothing"

    # Construct mappings (Robust Regex for the "M" issue)
    constructs:
      TP_LABEL:
        { keywords: ["threat_appraisal"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      TP_REASON: { keywords: ["threat_appraisal"], regex: ".*" }
      CP_LABEL:
        { keywords: ["coping_appraisal"], regex: "(?i)\\b(VL|L|M|H|VH)\\b" }
      CP_REASON: { keywords: ["coping_appraisal"], regex: ".*" }

  # Available Actions (mapped to Skill Registry IDs)
  actions:
    - id: buy_insurance
      aliases: ["FI", "insurance"]
      description: "Purchase flood insurance"
    - id: elevate_house
      aliases: ["HE", "elevate", "elevation"]
      description: "Elevate house structure"
    - id: relocate
      aliases: ["RL", "move"]
      description: "Relocate to safer area"
    - id: do_nothing
      aliases: ["DN", "nothing", "wait"]
      description: "Take no action this year"

  # Governance Profiles
  governance:
    strict:
      thinking_rules:
        - {
            construct: TP_LABEL,
            when_above: ["VH"],
            blocked_skills: ["do_nothing"],
            level: ERROR,
          }
        - {
            construct: CP_LABEL,
            when_above: ["VL"],
            blocked_skills: ["elevate_house", "relocate"],
            level: ERROR,
          }
        - {
            id: relocation_threat_low,
            conditions: [{ construct: TP_LABEL, values: ["VL", "L"] }],
            blocked_skills: ["relocate"],
            level: ERROR,
          }
        - {
            id: elevation_threat_low,
            conditions: [{ construct: TP_LABEL, values: ["VL", "L"] }],
            blocked_skills: ["elevate_house"],
            level: ERROR,
          }
      identity_rules:
        - {
            id: elevation_block,
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: ERROR,
          }

    relaxed:
      thinking_rules:
        - {
            construct: TP_LABEL,
            when_above: ["H"],
            blocked_skills: ["do_nothing"],
            level: WARNING,
          }
      identity_rules:
        - {
            id: elevation_block,
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: WARNING,
          }

metadata: { version: "v22-sa-final-parity-robust" }
