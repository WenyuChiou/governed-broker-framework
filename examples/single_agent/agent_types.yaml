# =============================================================================
# SHARED DEFINITIONS (Reusable across agent types)
# =============================================================================
shared:
  rating_scale: |
    ### RATING SCALE (You MUST use EXACTLY one of these codes):
    VL = Very Low | L = Low | M = Medium | H = High | VH = Very High

# =============================================================================
# HOUSEHOLD AGENT TYPE
# =============================================================================
household:
  description: "Household agents making adaptation decisions based on PMT"

  # Prompt Template (FINAL version aligned)
  prompt_template: |
    You are a homeowner in a city, with a strong attachment to your community. {elevation_status_text}
    Your memory includes:
    {memory}

    You currently {insurance_status} flood insurance.
    You {trust_insurance_text} the insurance company. You {trust_neighbors_text} your neighbors' judgment.

    Using the Protection Motivation Theory, evaluate your current situation by considering the following factors:
    - Perceived Severity: How serious the consequences of flooding feel to you.
    - Perceived Vulnerability: How likely you think you are to be affected.
    - Response Efficacy: How effective you believe each action is.
    - Self-Efficacy: Your confidence in your ability to take that action.
    - Response Cost: The financial and emotional cost of the action.
    - Maladaptive Rewards: The benefit of doing nothing immediately.

    Now, choose one of the following actions:
    {options_text}
    Note: If no flood occurred this year, since no immediate threat, most people would choose "Do Nothing."
    Note: If your Coping Appraisal is Low (VL or L), you CANNOT choose expensive actions like "Elevate House" or "Relocate".

    {rating_scale}

    Please respond using the exact JSON format below. Do NOT include any markdown symbols or conversational text.
    Use EXACTLY one of: VL, L, M, H, VH for each label.

    <<<DECISION_START>>>
    {{
      "threat_appraisal": {{"label": "M", "reason": "One sentence summary of how threatened you feel by any remaining flood risks."}},
      "coping_appraisal": {{"label": "M", "reason": "One sentence summary of how well you think you can cope or act."}},
      "decision": {valid_choices_text}
    }}
    <<<DECISION_END>>>

  # Parsing & Skill Mapping
  parsing:
    decision_keywords: ["final decision:", "decision:", "decide:"]
    default_skill: "do_nothing"
    global_skills: ["do_nothing", "buy_insurance", "buy_contents_insurance"]
    full_disclosure: true

    # Baseline Skill Mapping (numeric 1-4)
    skill_map_non_elevated:
      "1": "buy_insurance"
      "2": "elevate_house"
      "3": "relocate"
      "4": "do_nothing"

    skill_map_elevated:
      "1": "buy_insurance"
      "2": "relocate"
      "3": "do_nothing"

    # Construct mappings for validation and logging
    # Enhanced regex patterns to handle various LLM output formats (5-level: VL/L/M/H/VH)
    constructs:
      TP_LABEL:
        keywords: ["threat appraisal", "threat perception", "threat:", "tp:"]
        regex: "(?:threat\\s*(?:appraisal|perception)?|tp)[:\\s]*\\[?(VL|L|M|H|VH|Very Low|Low|Medium|Moderate|Med|High|Very High)\\]?"
      TP_REASON:
        keywords: ["threat appraisal", "threat perception"]
        regex: "(?:threat\\s*(?:appraisal|perception)?)[:\\s]*\\[?(?:VL|L|M|H|VH|Very Low|Low|Medium|Moderate|Med|High|Very High)\\]?[.,;:\\s]*(?:because|reason)?[:\\s]*(.+?)(?=\\n|coping|cp:|$)"
      CP_LABEL:
        keywords: ["coping appraisal", "coping perception", "coping:", "cp:"]
        regex: "(?:coping\\s*(?:appraisal|perception)?|cp)[:\\s]*\\[?(VL|L|M|H|VH|Very Low|Low|Medium|Moderate|Med|High|Very High)\\]?"
      CP_REASON:
        keywords: ["coping appraisal", "coping perception"]
        regex: "(?:coping\\s*(?:appraisal|perception)?)[:\\s]*\\[?(?:VL|L|M|H|VH|Very Low|Low|Medium|Moderate|Med|High|Very High)\\]?[.,;:\\s]*(?:because|reason)?[:\\s]*(.+?)(?=\\n|final|decision|final decision|$)"

  # Available Actions (mapped to Skill Registry IDs)
  actions:
    - id: buy_insurance
      aliases: ["FI", "insurance"]
      description: "Purchase flood insurance"
    - id: elevate_house
      aliases: ["HE", "elevate", "elevation"]
      description: "Elevate house structure"
    - id: relocate
      aliases: ["RL", "move"]
      description: "Relocate to safer area"
    - id: do_nothing
      aliases: ["DN", "nothing", "wait"]
      description: "Take no action this year"

  # Governance Profiles
  governance:
    strict:
      thinking_rules:
        # VH Threat + Inaction = CRITICAL ERROR (must retry)
        urgency_critical:
          {
            construct: TP_LABEL,
            when_above: ["VH", "Very High"],
            blocked_skills: ["do_nothing"],
            level: ERROR,
            message: "Critical: Very High Threat but inaction chosen. Must take protective action.",
          }
        # H Threat + Inaction = Warning (log but allow)
        urgency_warning:
          {
            construct: TP_LABEL,
            when_above: ["H", "High"],
            blocked_skills: ["do_nothing"],
            level: WARNING,
            message: "Warning: High Threat but inaction chosen. Consider protective action.",
          }
        coping_alignment:
          {
            construct: CP_LABEL,
            when_above: ["VL", "L", "Very Low", "Low"],
            blocked_skills: ["elevate_house", "relocate"],
            level: ERROR,
            message: "Logic Error: Low Coping but expensive action attempted.",
          }
        relocation_anomaly:
          {
            conditions:
              [{ construct: TP_LABEL, values: ["VL", "L", "Very Low", "Low"] }],
            blocked_skills: ["relocate"],
            level: ERROR,
            message: "Logical Error: Relocation is illogical when Threat is Low.",
          }
        elevation_anomaly:
          {
            conditions:
              [{ construct: TP_LABEL, values: ["VL", "L", "Very Low", "Low"] }],
            blocked_skills: ["elevate_house"],
            level: ERROR,
            message: "Logical Error: Elevation is irrational when Threat is Low.",
          }
      identity_rules:
        elevation_block:
          {
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: ERROR,
            message: "Status Error: Already elevated.",
          }

    relaxed:
      thinking_rules:
        urgency_check:
          {
            construct: TP_LABEL,
            when_above: ["H"],
            blocked_skills: ["do_nothing"],
            level: WARNING,
            message: "Suggestion: High Threat detected. Protection is recommended.",
          }
        coping_alignment:
          {
            construct: CP_LABEL,
            when_above: ["L"],
            blocked_skills: ["elevate_house", "relocate"],
            level: WARNING,
            message: "Observation: High-cost action despite low coping.",
          }
      identity_rules:
        elevation_block:
          {
            precondition: elevated,
            blocked_skills: ["elevate_house"],
            level: WARNING,
            message: "Note: Already elevated.",
          }
