# 元件：反思引擎（Meta-Cognition）

**語言： [English](reflection_engine.md) | [中文](reflection_engine_zh.md)**

記憶系統只存「發生了什麼」，而**反思引擎**產出「為什麼」。這是代理人的元認知層，將原始經歷轉化為可行動的洞見。

---

## 1. 反思引擎

### 1.1 從經驗到智慧的迴路

1. **輸入（情節記憶）**：「第 1 年：洪水」+「第 1 年：購買保險」
2. **處理（推理）**：LLM 分析事件與行動的因果關係
3. **輸出（語意洞見）**：「洞見：保險是洪水中財務存活的關鍵」

### 1.2 決策 vs 反思

| 維度 | 決策邏輯（System 1/2） | 反思邏輯（Meta） |
| :--- | :--- | :--- |
| **問題** | 「我現在該做什麼？」 | 「過去的決定好嗎？」 |
| **時間視野** | 當下 / 即時 | 過去 / 長期 |
| **機制** | In-Context Learning | 離線批次處理 |
| **輸出** | 行動 | 洞見 |

沒有反思，代理人只會「做出當下反應」；有了反思，代理人可以進化系統。

---

## 2. 反思的理論基礎

### 2.1 雙迴路學習（Argyris & Schon）

- **單迴路**：修正行動以達成目標
- **雙迴路**：反思目標是否合理（例如是否應該遷離）

### 2.2 認知經濟（地圖 vs 領土）

- 原始情節記憶搜尋成本高（「領土」），大而繁雜
- 反思將大量事件壓縮為少數規則（「地圖」）

### 2.3 噪音過濾

反思作為**低通濾波器**，忽略一次性異常，放大一致趨勢。

### 2.4 比較結果：「金魚」vs「策略家」

| 指標 | 無反思（僅 System 1/2） | 有反思（Meta） |
| :--- | :--- | :--- |
| **反應模式** | 恐慌循環 / 反覆 | 發現趨勢後永久調整 |
| **記憶壽命** | 指數衰減 | 洞見永久 `retention=1.0` |
| **效率** | 每年重新分析事件 | 只需一條規則 |
| **盲點** | 溫水煮蛙效應 | 趨勢偵測 |

---

## 3. 實際案例：反思迴路（Input → Process → Output）

#### **1. 輸入：原始記憶**

- **Year 1**：「洪水，未採取行動」→ $10k 損失
- **Year 3**：「洪水，購買保險」→ $0 損失
- **Year 4**：「鄰居 A 抬升，鄰居 B 遷離」

#### **2. 處理：推理輸出**

> 「洪水頻繁（Y1、Y3），不行動會導致損失；保險可保護財務，但鄰居開始採取永久措施。」

#### **3. 輸出：語意洞見**

- **洞見 A**：「待在洪氾區被動不作為有財務風險」
- **洞見 B**：「保險是暫時保護，抬升是永久解法」

---

## 4. 觸發式反思（Task-059）

v3.3 之前，反思僅為**週期性**（年末合併）。觸發式系統新增**事件驅動反思**，讓代理人在重大事件後立即反思。

### 4.1 觸發類型

`ReflectionTrigger` 列舉定義四種觸發：

| 觸發 | 觸發時機 | 適用角色 | 範例 |
| :--- | :--- | :--- | :--- |
| **CRISIS** | 洪水或災難事件後 | 全部 | 遭受洪損 → 反思防備 |
| **PERIODIC** | 每 N 年（可設定） | 全部 | 年末合併（預設間隔：5） |
| **DECISION** | 重大決策後 | 家戶 | 選擇 `elevate_house` → 反思選擇 |
| **INSTITUTIONAL** | 政策變動幅度超過閾值 | 政府、保險 | 補貼率變動 > 5% → 反思政策效果 |

### 4.2 設定

```yaml
reflection_triggers:
  crisis: true
  periodic_interval: 5
  decision_types:
    - "elevate_house"
    - "buyout_program"
    - "relocate"
  institutional_threshold: 0.05
  method: "hybrid"
  batch_size: 10
  importance_boost: 0.85
```

### 4.3 理論動機

此設計對應 **Reflection-in-Action**（Schon 1983）：代理人在重大事件_期間_反思，而非僅在_事後_。危機觸發實現了心理學觀察——創傷事件迫使立即認知重新評估。

INSTITUTIONAL 觸發支援組織層級的**雙迴路學習**（Argyris & Schon 1978）：政府與保險代理人質疑其_政策_（而非僅行動）是否有效。

---

## 5. 設定與參考文獻

```yaml
reflection_config:
  interval: 1 # 每年反思
  importance_boost: 0.9 # 洞見「持久性」
```

### 參考文獻

[1] Schon (1983). _The Reflective Practitioner_
[2] Dewey (1933). _How We Think_
[3] Argyris (1976). _Single-Loop and Double-Loop Models_
[4] Bandura (1977). _Social Learning Theory_
[5] Park et al. (2023). _Generative Agents_
[6] Kahneman (2011). _Thinking, Fast and Slow_
