# Flood Adaptation Domain Configuration
# 完整整合現有實驗設計

domain_name: "flood_adaptation"
description: "PMT-based flood adaptation ABM with LLM agents"

# =============================================================================
# AGENT STATE
# =============================================================================
state_schema:
  agent:
    # 核心狀態
    elevated: bool            # 房屋是否加高
    has_insurance: bool       # 是否有保險
    relocated: bool           # 是否已遷移
    
    # PMT 信任變量
    trust_in_insurance: float  # 0.0-1.0
    trust_in_neighbors: float  # 0.0-1.0
    
    # 歷史
    flood_threshold: float     # 脆弱度閾值
    flood_history: list        # 洪水經歷年份
    yearly_decisions: list
    threat_appraisals: list
    coping_appraisals: list
    
  memory:
    events: list               # 記憶事件 (max 5)
    window_size: 5

  environment:
    year: int
    flood_event: bool
    flood_severity: float
    grant_available: bool

# =============================================================================
# OBSERVABLE SIGNALS (LLM 可見)
# =============================================================================
observable_signals:
  agent:
    - elevation_status_text    # "Your house is already elevated..."
    - insurance_status_text    # "have" / "do not have"
    - trust_insurance_text     # verbalized trust
    - trust_neighbors_text     # verbalized trust
    - memory                   # 最近 5 條記憶
  environment:
    - flood_status             # "A flood occurred this year..." / "No flood..."
    - options_text             # 可用選項文字
    - valid_choices_text       # "1, 2, 3, or 4"

# =============================================================================
# HIDDEN STATE (LLM 不可見)
# =============================================================================
hidden_state:
  - flood_threshold
  - flood_history
  - seed
  - internal_probabilities

# =============================================================================
# ACTION CATALOG
# =============================================================================
action_catalog:
  # 非加高狀態的選項 (1=FI, 2=HE, 3=Relocate, 4=DN)
  non_elevated:
    buy_flood_insurance:
      code: "1"
      description: "Buy flood insurance (Lower cost, provides partial financial protection)"
      constraints:
        - "not agent.has_insurance"
      effects:
        has_insurance: true
        
    elevate_house:
      code: "2"
      description: "Elevate your house (High upfront cost but prevents most damage)"
      constraints:
        - "not agent.elevated"
      effects:
        elevated: true
        
    relocate:
      code: "3"
      description: "Relocate (Leaves neighborhood but eliminates flood risk)"
      constraints:
        - "not agent.relocated"
      effects:
        relocated: true
        is_active: false
        
    do_nothing:
      code: "4"
      description: "Do nothing (No investment, but exposed to flood damage)"
      constraints: []
      effects: {}

  # 已加高狀態的選項 (1=FI, 2=Relocate, 3=DN)
  elevated:
    buy_flood_insurance:
      code: "1"
      description: "Buy flood insurance"
      constraints:
        - "not agent.has_insurance"
      effects:
        has_insurance: true
        
    relocate:
      code: "2"
      description: "Relocate"
      constraints: []
      effects:
        relocated: true
        is_active: false
        
    do_nothing:
      code: "3"
      description: "Do nothing"
      constraints: []
      effects: {}

# =============================================================================
# VALIDATORS
# =============================================================================
validators:
  enabled:
    - SchemaValidator
    - PolicyValidator
    - FeasibilityValidator
    - LeakageValidator
    - MemoryIntegrityValidator
    
  domain_validators:
    - PMTConsistencyValidator    # Rule 4: High threat + High efficacy + DN
    - FloodResponseValidator     # Rule 5: Flooded + Claims safe

# =============================================================================
# MEMORY RULES (Dynamic Memory Update)
# =============================================================================
memory_rules:
  # 洪水事件記憶
  flood_event:
    template: "Year {year}: A flood occurred and caused damage to many homes in the area."
    
  no_flood:
    template: "Year {year}: No flood occurred this year."
    
  # 決策記憶
  decision_made:
    buy_insurance: "Year {year}: You purchased flood insurance for protection."
    elevate: "Year {year}: You elevated your house to reduce flood risk."
    relocate: "Year {year}: You decided to relocate to a safer area."
    do_nothing: "Year {year}: You chose to take no action this year."
    
  # 隨機歷史回憶
  random_recall:
    probability: 0.2
    events:
      - "A few households in the area elevated their homes before recent floods."
      - "You recall a conversation with a neighbor who lost everything in a past flood."
      - "The local news recently covered flood preparedness tips."
      - "You remember seeing insurance advertisements promising fast payouts."
      - "A community meeting discussed the increasing flood risks in the region."

# =============================================================================
# TRUST UPDATE RULES (Dynamic Trust Update)
# =============================================================================
trust_update_rules:
  insurance:
    # Scenario A: Insured + Flooded ("The Hassle")
    insured_flooded:
      delta: -0.10
      
    # Scenario B: Insured + Safe ("Peace of Mind")
    insured_safe:
      delta: +0.02
      
    # Scenario C: Not Insured + Flooded ("Hard Lesson")
    not_insured_flooded:
      delta: +0.05
      
    # Scenario D: Not Insured + Safe ("Gambler's Reward")
    not_insured_safe:
      delta: -0.02
      
  neighbors:
    # High community action rate
    high_action_threshold: 0.30
    high_action_delta: +0.04
    
    # Low action during flood
    low_action_flooded_delta: -0.05
    
    # Default decay
    default_delta: -0.01

# =============================================================================
# RETRY POLICY
# =============================================================================
retry_policy:
  max_retries: 2
  retry_on:
    - SchemaValidator
    - PolicyValidator
    - PMTConsistencyValidator
  fallback_action: do_nothing
  uncertain_threshold: 0.3

# =============================================================================
# AUDIT
# =============================================================================
audit:
  log_level: full
  trace_fields:
    - run_id
    - step_id
    - timestamp
    - seed
    - agent_id
    - year
    - memory_pre
    - memory_post
    - llm_output
    - threat_appraisal
    - coping_appraisal
    - validator_results
    - action_request
    - admissible_command
    - execution_result
    - state_diff
    - trust_before
    - trust_after
    - outcome
    - retry_count
  rotation:
    enabled: true
    max_entries_per_file: 10000
